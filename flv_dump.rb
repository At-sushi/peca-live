channels_text = "あれくま<>B9EFEA63DC4B2C38ED83BEB3F60BAFE7<>219.117.192.180:7144
クレック<>357853C785A103DFD8DE279271D3B98C<>119.229.21.45:7144
やる気まいなす８億光年<>E0DF6191133E25E76416FCB2F51BF794<>180.178.88.27:8888
黒ニット<>7552B933ACAFCA280F85036DD766C1CC<>180.146.84.100:7144
そそなかch<>FA9433407C5FF4D4CD5462C7FE9CAE07<>114.150.113.145:7144
むちょ<>739D4AD8EA14B3E01EBFF105A3D413EC<>60.33.15.183:7144
スターマインch<>9F13CCA9A4F55756E64FBF06AB5A3F8B<>180.196.160.224:7144
そらりねった<>9EFBA267AC2E62D7AA8B50AB2170690A<>14.8.132.96:4736
タンク姫川<>97AFC23BD7586C641409B192DA71B7A8<>49.212.151.50:7148
くろけだま<>97DC91ACE754DA38FE89A0C2652A89DD<>101.128.216.121:7144
伐採ch<>901CAE4A50E19828C08F4C6EDA14BABA<>153.232.14.227:7144
イチch<>EAE63A1D2CDFC1FA8A64ECC0B43AFA42<>111.65.213.148:7144
BKS(Lv.40)<>FB0E233C60CF53BAF510B2B1EA24976A<>180.39.73.64:7144
あくえり<>97F828FA3FD3DA7F1C9FD77CA16AA9C5<>126.117.44.178:7144
telepoman<>2C7BA0DD4E8D7603058ADC958DAADD59<>122.102.141.15:7144
アジーン<>B021EE7EA1DA4473B72C455772953C05<>106.72.163.97:29999
テライケメン<>972066C9CD07FF608B33894A7FB86785<>180.94.250.13:7144
サカス<>1A803C5A20627EB8414A384C6212DF6B<>49.129.246.146:7144
黄色ch<>9D289D1CE14262A5B2FB3190F9F755E4<>116.94.125.151:7144
黄色ch FLV<>3806CF1A2C15010475D970A2BA179B33<>116.94.125.151:7146
(　´Д｀) やすひろch<>CF047019E452B31881AC9E2B09394C0B<>112.70.138.192:7144
marukome<>6B913C2D3EC0A446E5BED12AA4C86379<>14.10.1.96:7590
みぃch<>346FE70E919591CF78CE058E4F1FEF2D<>222.12.95.167:7144
koge_CH<>7D69284A0F0F887A88660ACB74A147ED<>61.201.140.30:7145
ドット打ちれんしゅう<>73352BC46754FFA484CC968993542ABC<>114.18.186.85:7148
どくぺ配信<>A3FDE86974FEAFEC2B3B58AFEDACF671<>150.249.73.45:7144
くずやch<>C1174A95EEB3D5C2D50F430312E1482B<>60.125.83.116:7144
マッサム配信<>50B06AEFD172996CEA487449873E43D2<>120.75.246.198:7144
タイガー<>63FBE59367BD43D2AD11F5B08EC9C0CC<>116.58.163.39:7144
ちゃんぽん<>67040F8E6680A63F6120AD2281B6C258<>60.112.193.120:7144
ふらがch<>1A14716A8C244DD8406AD6C2E3E3DE55<>153.222.225.66:7144
葱者<>87A6A16F63384D71B32B0B2E20151DBB<>112.70.207.153:7146
かっこーｃｈ<>85C3C04E939DEBEB8545198A25D63ADD<>180.28.105.156:7144
エルビダ<>EA8F85F461AF616CCCBBDBA4EA3282CA<>202.174.216.131:7144
だいちゃ<>F582F5998355CBDAB1CC7FA4A0675A01<>160.248.99.201:7156
せんちゅりおそ<>EAF12F8E9AAE64096E9E0715481E741E<>14.133.139.65:7144
DODGEch<>FECD379C3C372634E6F5D549E94D0A51<>118.83.251.109:7144
毒コロネ<>4787E7EBFF6D459B0E83B077E23DFF88<>153.208.97.63:7144
Kitami<>D85AE4CE15B5A491D510AED9B8BAD6C9<>222.2.240.171:7144
MABARIKO<>50055B67DB006573180E51E7E3BD7754<>153.166.181.81:7144
えんでゅ<>CA42B14C56F110E6EABFCBBCA3C54196<>39.111.175.93:7144
あるつ<>086681A6B990FB9824EB9884E184D110<>121.109.138.249:7144
すべん<>C23A9A47A53FD5771EC18408DF5EA086<>27.114.117.7:7144
ファイナルハゲ<>B1940F75D93337F22C798C0888B8BB87<>211.134.114.49:7144
赤富士<>9BDF4D1B002C774A93D9D297CE34B7D6<>49.212.151.50:7152
Sch<>3219F81A870495FE3338823F7BE658FA<>125.195.96.199:7144
戦後ch<>20A808052402D55502EA5453B986832B<>125.202.252.69:7144
千鶴子マン<>96FB5F44F47312EBCB0E459E6C2A6D23<>118.111.176.192:7144
ひまりあch<>90EB5B1D2E1E716BB23ABBA009B918B9<>49.212.151.50:7152
MOXch<>0F46F2EFCFE8B117FC6C506F08C04545<>49.212.151.50:7152
ロペちゃんねる<>FDDBBD1F03F28BC2ABA01D70DD35EE63<>118.240.170.23:7144
コートダジュール山田支店<>2D9B9B8E9D22C75DE3422C91E93CB1CB<>106.187.56.99:7144
三輪車<>7F7A78B8106C7FC67A550DF05B65EFB4<>180.22.138.54:7144
ﾌｧﾙﾅch<>C1FFE3E8FC5093E6CCEE5224623036CC<>153.215.194.226:7144
ふみ<>6B49834E695EA2215290156CCC747856<>58.189.69.207:7144
せらひむch<>5642E1685FBB1EF0D079B2B36E93707B<>133.200.169.64:5627
やさいｃｈ<>EC858EA30C0D89F24E7E2FC6345A9BE6<>14.132.24.11:7144
さぶりが<>81F3BE98DAA55BFDB2EB694C6D9EE8D1<>61.121.230.140:7144
不ぅ眠<>71CA303342C9355A84855895D04FFD72<>131.129.201.13:7144
0501<>D80DE8FA12561E649E95A6DE3BAE9C63<>210.255.248.80:7144
あいぜん<>CF9E1F3BF35102554EFB20A4176E3219<>153.144.48.185:7144
ロミュラン<>14E28F27FF7A6B2E961BC59DC68D99E0<>211.121.75.10:7144
Rch<>1548EDE8443883745BD8E6654E1DF3C0<>153.178.221.27:7144
よっぱちゃん寝る<>D756E1812B87A11530504E10866553D8<>92.202.64.207:7144
Sithlord ch<>A38FCFAEE1620862DE5024F124A6CE84<>219.106.80.216:7144
ご<>D2BF337DE7A3F5425CADE3EAEBC9EE79<>60.143.40.57:7144
うなぎの配信<>1D9386D8EE5C758C1A94FB8DE7736DAC<>60.120.161.224:7144
ぴーがら<>D246063777B0B7D35797EF7C7BC7C17B<>101.142.249.178:7146
bonox2<>2C841B4FC7D5EAFA6ADB91246A05B513<>106.166.72.4:7144
エルバ<>9061B12DFB22740B10ED6EFFC464D681<>153.223.33.225:7144
ぺるりch<>914DFC1B1EF2CE7076095CEEDF5BE4A0<>116.82.243.16:7144
トミーXP<>3D8A7F2B47D3208AFEF7223AF2F96351<>211.14.237.194:7144
パネる<>90E947293D40671BC0DA96E6E92FFEA4<>49.212.151.50:7152
くのう<>9067F071036B92D49544B52EAF0F112B<>180.198.124.104:7145
まぶしいくらいの衣装で殺して<>6A884F158616AA8B6341CD4FA3A5A5E0<>159.28.250.229:7144
薄馬鹿<>D6A102985C57050D4D7633C8953A8EA9<>182.166.196.114:7144
腹ぺこchannel<>6A1EBF12BA7454792DFDAF40D16716F9<>36.8.165.154:7144
エイチ<>267476FC05596AB7FB9064E20F257DA0<>60.238.74.160:7145
あんばさ<>8EAEC4DAA17AFA04D54F96243AF01BCE<>121.3.228.130:7150
Ｃ調ch<>3795BF144ADBF5AE51227BE4E2D10255<>14.9.65.64:5330
ヨモギラ<>E77309FC94790055F988FA5EB8A90E78<>60.124.1.108:7144
飛翔兎ch<>2CB9CCC878218012723810585D53E880<>160.86.139.44:7145
オヤシロch<>58AF4455FA656F20BC4755691F8EC915<>60.147.213.123:7144
しのぶch<>10A07CCAA37EB1881C7542AE3B33988F<>222.1.164.106:7144
げch<>E15E473EEF24347D8DFBE45919CCCD8F<>114.149.96.19:7144
たこなぐり<>74F77D126A2D781DB76390F64C9D98A3<>121.105.26.115:7144
みかるちゃんねる<>E4044E1B438BCA13E0DF3C34A9664009<>147.192.109.36:7144
萬田<>477035E441C9D9D33F6C74236185246E<>125.192.67.151:7144
キング<>90E804293D7E671BFBDAE9E7D52FFE9A<>49.212.151.50:7152
幽ch<>3A946D54E6CE0C69D302EFE2CF13F355<>128.53.72.132:7144
ヤッチch<>60540B18AD1D52EA55CAF3CF82B3780F<>124.159.128.72:7144
沙竹唯ch<>21D8AE60D661424D5F72FC52584C1C6B<>60.126.92.53:7144
TATch<>B017C5EF4F00B24A6C37A9653F392558<>58.189.82.17:7021
瞬光ch<>1B137A7DBDB20E96C05256B972E7A1E7<>113.147.108.60:7144
はじ<>1E25824B116655BA968142DEBBC78C5B<>114.161.49.91:7144
おるご<>FEBEEBF437C59C7953008EE1B0F398F4<>112.69.93.100:7144
しろた<>F9A590E143E2842843B36309201C6000<>49.135.99.94:7144
干支ch<>01F4A5F142A8DE98EAEB98C85A0001B8<>218.110.109.216:7144
ひびのｃｈ<>77F42AA8E8CB5EFF76870F204BD5482F<>106.72.52.160:5744
トガ<>07F7F90E1353C8705430F71C407F7277<>126.116.49.241:7144
がめおう゛ぇ<>A89129F1309B50641689FF4DDDD9610E<>180.46.252.101:7144
べぇた<>719753498889FBA383833FF9DC29C20D<>106.73.212.224:4624
NURO光120FPS配信<>D3C4FDCBE2D701834E06C557804A8187<>160.86.216.74:7144"



channels_text.each_line do |line|
  name, channnel_id, tip = line.chomp.split("<>")
  # command = "rtmpdump -r \"http://localhost:7144/pls/#{channnel_id}?tip=#{tip}\" -o xxx_#{name}.flv"
  #
  # pid = spawn(command, :pgroup => true)  # :pgroup => trueを追加
  # sleep(5)
  # Process.kill(:TERM, -pid)        # -pidに変更

  command = "rtmpdump -r \"http://localhost:7144/pls/#{channnel_id}?tip=#{tip}\" -o \"#{name}.flv\" --live"
  pid = spawn(command, :pgroup => true)  # :pgroup => trueを追加
  sleep(5)
  Process.kill(:TERM, -pid)        # -pidに変更

  # thr = Process.detach(pid)
  # begin
  #   Timeout.timeout(3) do
  #     sleep(10)
  #     thr.join
  #   end
  # rescue Timeout::Error
  #   puts "execution expired"
  # end

  # timeout(10) do
  #   sleep(100)
  # end
  # t = Thread.new do
  #   system(command)
  # end
  # sleep(10)
  # t.kill
  # break

rescue => e
  pp e: e
end
